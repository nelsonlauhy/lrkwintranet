<script src="https://alcdn.msauth.net/browser/2.31.0/js/msal-browser.min.js"></script>
<script src="msalconfig.js"></script>
<script>
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  msalInstance.handleRedirectPromise()
    .then(response => {
      const account = response?.account || msalInstance.getAllAccounts()[0];
      if (account) {
        msalInstance.setActiveAccount(account);
        msalInstance.acquireTokenSilent({ scopes: ["User.Read"] }).then(tokenResponse => {
          sessionStorage.setItem("user", JSON.stringify({
            username: account.username,
            name: account.name,
            token: tokenResponse.accessToken
          }));

          // Optional: fetch jobTitle or more details
          fetch("https://graph.microsoft.com/v1.0/me", {
            headers: {
              Authorization: `Bearer ${tokenResponse.accessToken}`
            }
          }).then(res => res.json())
            .then(profile => {
              sessionStorage.setItem("jobTitle", profile.jobTitle || "");
              window.location.href = "dashboard.html";
            });
        }).catch(() => {
          // Token failed silently, do login redirect
          msalInstance.loginRedirect({ scopes: ["User.Read"] });
        });
      } else {
        // No account found â€” force login
        msalInstance.loginRedirect({ scopes: ["User.Read"] });
      }
    })
    .catch(err => console.error("Login error:", err));
</script>
