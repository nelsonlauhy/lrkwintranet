<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Living Realty KW - Sign In</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex justify-content-center align-items-center vh-100">
  <div class="text-center">
    <img src="images/logo.png" alt="Living Realty KW Logo" style="max-width: 200px;">
    <h2 class="my-4">Welcome to Living Realty KW</h2>
    <p>Signing you in...</p>
  </div>

  <!-- MSAL + config -->
  <script src="https://alcdn.msauth.net/browser/2.31.0/js/msal-browser.min.js"></script>
  <script>
    const msalConfig = {
      auth: {
        clientId: "cf01424e-21e3-4b98-bb96-93d91e32cf7b",
        authority: "https://login.microsoftonline.com/9f6c51b3-4040-49cf-a898-30bb9f2cfc92",
        redirectUri: window.location.origin
      },
      cache: {
        cacheLocation: "localStorage",  // persist across tabs and sessions
        storeAuthStateInCookie: false
      }
    };
  </script>
  <script>
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    msalInstance.handleRedirectPromise()
      .then(response => {
        const account = response?.account || msalInstance.getAllAccounts()[0];
        if (account) {
          msalInstance.setActiveAccount(account);

          msalInstance.acquireTokenSilent({ scopes: ["User.Read"] })
            .then(tokenResponse => {
              return fetch("https://graph.microsoft.com/v1.0/me", {
                headers: {
                  Authorization: `Bearer ${tokenResponse.accessToken}`
                }
              }).then(res => res.json())
                .then(profile => {
                  const userData = {
                    username: account.username,
                    name: account.name,
                    firstName: profile.givenName || "",
                    lastName: profile.surname || "",
                    email: profile.mail || account.username,
                    jobTitle: profile.jobTitle || "",
                    token: tokenResponse.accessToken
                  };

                  localStorage.setItem("user", JSON.stringify(userData));
                  window.location.href = "dashboard.html";
                });
            })
            .catch(error => {
              console.error("Silent token acquisition failed", error);
              msalInstance.loginRedirect({ scopes: ["User.Read"] });
            });
        } else {
          msalInstance.loginRedirect({ scopes: ["User.Read"] });
        }
      })
      .catch(error => {
        console.error("Redirect error", error);
      });
  </script>
</body>
</html>
